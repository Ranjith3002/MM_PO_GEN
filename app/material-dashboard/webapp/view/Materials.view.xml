<mvc:View
    controllerName="ai.mm.materialdashboard.controller.Materials"
    xmlns:mvc="sap.ui.core.mvc"
    displayBlock="true"
    xmlns="sap.m"
    xmlns:core="sap.ui.core">
    
    <Page id="materialsPage" title="{i18n>materialsViewTitle}" showNavButton="true" navButtonPress="onNavBack">
        <content>
            <VBox class="sapUiMediumMargin">
                <!-- Header with search and refresh -->
                <HBox justifyContent="SpaceBetween" alignItems="Center" class="sapUiMediumMarginBottom">
                    <Title text="{i18n>materialsViewTitle}" level="H2" />
                    <HBox>
                        <SearchField 
                            id="searchField"
                            placeholder="{i18n>searchPlaceholder}" 
                            search="onSearch"
                            width="300px"
                            class="sapUiMediumMarginEnd" />
                        <Button 
                            text="{i18n>refreshBtn}" 
                            icon="sap-icon://refresh" 
                            press="onRefresh" />
                    </HBox>
                </HBox>

                <!-- Status Message -->
                <MessageStrip
                    id="statusMessage"
                    text="Loading materials data..."
                    type="Information"
                    visible="true"
                    class="sapUiMediumMarginBottom" />

                <!-- Materials Table -->
                <Table
                    id="materialsTable"
                    items="{
                        path: '/Materials',
                        events: {
                            dataRequested: '.onDataRequested',
                            dataReceived: '.onDataReceived'
                        }
                    }"
                    growing="true"
                    growingThreshold="20"
                    mode="None"
                    class="sapUiResponsiveMargin"
                    busy="{/busy}"
                    noDataText="No materials found. Please check your data connection."
                    visible="{= ${/Materials}.length > 0 }">
                    
                    <headerToolbar>
                        <Toolbar>
                            <Title text="{i18n>materialsTitle}" />
                            <ToolbarSpacer />
                            <VBox alignItems="End">
                                <Text text="Total: {view>/materialsCount} materials" />
                                <Text text="Low Stock: {view>/lowStockCount} items" class="sapUiTinyText" />
                            </VBox>
                        </Toolbar>
                    </headerToolbar>

                    <columns>
                        <Column width="30%">
                            <Text text="Material Details" />
                        </Column>
                        <Column width="20%">
                            <Text text="Stock &amp; Status" />
                        </Column>
                        <Column width="15%">
                            <Text text="Supplier &amp; Price" />
                        </Column>
                        <Column width="35%">
                            <Text text="ðŸ¤– AI Actions &amp; Insights" />
                        </Column>
                    </columns>

                    <items>
                        <ColumnListItem press="onMaterialPress">
                            <cells>
                                <!-- Material Details Column -->
                                <VBox>
                                    <HBox alignItems="Center" class="sapUiTinyMarginBottom">
                                        <core:Icon src="sap-icon://product" color="Default" class="sapUiTinyMarginEnd" />
                                        <Text text="{name}" class="sapMTitle" />
                                    </HBox>
                                    <Text text="{description}" class="sapUiTinyText sapUiTinyMarginBottom" />
                                    <HBox class="sapUiTinyMarginTop">
                                        <ObjectStatus text="{categoryName}" state="Information" class="sapUiTinyMarginEnd" />
                                        <ObjectStatus text="{location}" state="None" />
                                    </HBox>
                                </VBox>

                                <!-- Stock & Status Column -->
                                <VBox>
                                    <HBox alignItems="Center" class="sapUiTinyMarginBottom">
                                        <ObjectNumber
                                            number="{currentStock}"
                                            unit="{unitOfMeasure}"
                                            state="{
                                                parts: ['currentStock', 'reorderLevel'],
                                                formatter: '.formatStockState'
                                            }"
                                            emphasized="true" />
                                        <core:Icon
                                            src="{
                                                parts: ['currentStock', 'reorderLevel'],
                                                formatter: '.formatStockIcon'
                                            }"
                                            color="{
                                                parts: ['currentStock', 'reorderLevel'],
                                                formatter: '.formatStockIconColor'
                                            }"
                                            class="sapUiTinyMarginBegin" />
                                    </HBox>
                                    <Text text="Reorder: {reorderLevel} {unitOfMeasure}" class="sapUiTinyText" />
                                    <Text text="Lead Time: {leadTime} days" class="sapUiTinyText" />
                                    <Text text="Safety Stock: {safetyStock}" class="sapUiTinyText" />
                                </VBox>

                                <!-- Supplier & Price Column -->
                                <VBox>
                                    <Text text="{supplierName}" class="sapMTitle sapUiTinyMarginBottom" />
                                    <ObjectNumber
                                        number="{unitPrice}"
                                        unit="{currency_code}"
                                        class="sapUiTinyMarginBottom" />
                                    <Text text="Total Value: {
                                        parts: ['currentStock', 'unitPrice'],
                                        formatter: '.formatTotalValue'
                                    }" class="sapUiTinyText" />
                                </VBox>

                                <!-- AI Actions & Insights Column -->
                                <VBox>
                                    <HBox class="sapUiTinyMarginBottom">
                                        <Button
                                            text="ðŸ¤– Predict"
                                            type="Transparent"
                                            icon="sap-icon://trend-up"
                                            press="onAIPredictDepletion"
                                            class="sapUiTinyMarginEnd" />
                                        <Button
                                            text="ðŸ›’ Generate PO"
                                            type="Emphasized"
                                            icon="sap-icon://add-document"
                                            press="onAIGeneratePO"
                                            enabled="{
                                                parts: ['currentStock', 'reorderLevel'],
                                                formatter: '.formatPOButtonEnabled'
                                            }" />
                                    </HBox>
                                    <VBox class="sapUiTinyMarginTop">
                                        <Text
                                            id="aiStatusText"
                                            text="Click Predict for AI insights"
                                            class="sapUiTinyText" />
                                        <ObjectStatus
                                            id="aiConfidenceStatus"
                                            text="AI Ready"
                                            state="Information"
                                            class="sapUiTinyMarginTop" />
                                    </VBox>
                                </VBox>
                            </cells>
                        </ColumnListItem>
                    </items>
                </Table>
            </VBox>
        </content>
    </Page>
</mvc:View>
